# Spectro Terraform Formatter (spectro-tf-format)

A powerful, configurable CLI tool for post-processing Terraform files generated by Spectro Cloud operations. Transform escaped YAML content into clean, separate files with configurable formatting rules.

## 🚀 Features

- **📝 YAML Extraction**: Convert escaped YAML strings to clean, separate files
- **🔧 Configurable Rules**: Modular formatting system with extensible rules  
- **⚙️ Configuration-Driven**: YAML/JSON configuration files for different environments
- **🔄 Multiple Environments**: Development, staging, and production configs
- **💾 Safe Operations**: Automatic backups and validation

## Problem Statement

When using `terraform plan -generate-config-out=generated.tf` with custom cloud imports, YAML content gets escaped as single-line strings:

**Before (Generated by Terraform):**
```hcl
cloud_config {
  values = "apiVersion: cluster.x-k8s.io/v1beta1\nkind: Cluster\nmetadata:\n    name: my-cluster\n..."
}
```

**After (Processed by spectro-tf-format):**
```hcl
cloud_config {
  values = file("configs/cluster_cloud_config.yaml")
}
```

## Installation

### Prerequisites
- Python 3.6 or higher
- pip (Python package installer)

### Install Dependencies
```bash
# Install Python dependencies
pip install -r spectrocloud/scripts/requirements.txt

# Or using python3 directly
python3 -m pip install -r spectrocloud/scripts/requirements.txt
```

### Install the Tool
```bash
# Make the tool executable
chmod +x spectrocloud/scripts/spectro-tf-format

# Add to PATH (optional for easier access)
export PATH="$PATH:$(pwd)/spectrocloud/scripts"

# Verify installation
spectro-tf-format --help
```

### Alternative: Direct Usage
```bash
# Run directly without adding to PATH
python3 spectrocloud/scripts/spectro-tf-format --help
```

## Quick Start

### 1. Basic Usage (Default YAML Formatting)
```bash
# Generate Terraform configuration
terraform plan -generate-config-out=generated.tf

# Format with default settings
spectro-tf-format generated.tf
```

### 2. Use Configuration File
```bash
# Create default configuration
spectro-tf-format --init-config=my-config.yaml

# Use custom configuration
spectro-tf-format --config=my-config.yaml generated.tf
```

### 3. Apply Specific Rules
```bash
# Apply YAML formatting (this is the default)
spectro-tf-format --rule=yaml-format generated.tf

# Custom output directory
spectro-tf-format --output-dir=configs generated.tf
```

## Complete Workflow Example

```bash
# 1. Import existing custom cloud cluster
cat > import.tf << EOF
import {
  to = spectrocloud_cluster_custom_cloud.example  
  id = "cluster123:project:nutanix"
}
EOF

# 2. Generate configuration
terraform plan -generate-config-out=generated.tf

# 3. Create configuration file for your environment
spectro-tf-format --init-config=project-config.yaml

# 4. Customize the configuration (edit project-config.yaml)
# 5. Process the generated file
spectro-tf-format --config=project-config.yaml generated.tf

# 6. Review results
ls configs/
# Output: cluster_cloud_config.yaml, cluster_control-plane-pool_config.yaml

# 7. Verify changes
terraform plan

# 8. Clean up import block
rm import.tf
```

## Available Formatting Rules

### 1. yaml-format
**Extracts YAML content into separate files**
- ✅ Detects escaped YAML in `cloud_config.values` 
- ✅ Detects escaped YAML in `machine_pool.node_pool_config`
- ✅ Unescapes `\n`, `\"`, `\\`, etc.
- ✅ Formats multi-document YAML properly
- ✅ Configurable file naming patterns

## Configuration Options

### Configuration File Structure

```yaml
# Basic settings
rules: ["yaml-format"]
output_dir: "configs"
backup: true

# Field-specific YAML extraction
yaml_config:
  # Specify exactly which terraform attributes to extract
  "cloud_config.values": "{resource_name}_cloud_config.yaml"
  "machine_pool.node_pool_config": "{resource_name}_{pool_name}_config.yaml"
```

### Field-Specific Configuration

You can now configure exactly which fields to extract:

```yaml
# Extract only cloud config
yaml_config:
  "cloud_config.values": "cluster_{resource_name}_config.yaml"

# Extract only machine pools  
yaml_config:
  "machine_pool.node_pool_config": "pool_{resource_name}_{pool_name}.yaml"

# Extract both with custom patterns
yaml_config:
  "cloud_config.values": "clusters/{resource_name}/cloud-config.yaml"
  "machine_pool.node_pool_config": "clusters/{resource_name}/pools/{pool_name}.yaml"
```

### Advanced YAML Templating

**🚀 NEW FEATURE**: Extract values from YAML and parameterize them as Terraform variables!

```yaml
yaml_config:
  "cloud_config.values":
    filename: "{resource_name}_cloud_config.yaml"
    templating:
      - path: "Cluster.metadata.name"
        variable: "CLUSTER_NAME"
      - path: "AWSCluster.spec.region"
        variable: "AWS_REGION"
      - path: "Cluster.spec.clusterNetwork.pods.cidrBlocks[0]"
        variable: "POD_CIDR"
```

**What happens:**

1. **Values are extracted** from specific YAML paths
2. **YAML is templated** with variable placeholders: `${CLUSTER_NAME}`
3. **Overrides are generated** in Terraform:

```hcl
cloud_config {
  overrides = {
    CLUSTER_NAME = "kun-simulate-tmo"
    AWS_REGION   = "us-west-2" 
    POD_CIDR     = "192.168.0.0/16"
  }
  values = file("yaml_configs/cluster_cloud_config.yaml")
}
```

#### Path Syntax Support

- **Simple paths**: `Cluster.metadata.name`
- **Nested objects**: `spec.template.spec.instanceType` 
- **Array access**: `spec.cidrBlocks[0]`, `subnets[1].id`
- **Multi-document**: Works across all YAML documents in the file

#### Templating Examples

**Cloud Configuration:**
```yaml
"cloud_config.values":
  filename: "{resource_name}_cloud_config.yaml"
  templating:
    - path: "Cluster.spec.infrastructureRef.name"
      variable: "INFRA_REF_NAME"
    - path: "AWSCluster.spec.sshKeyName"
      variable: "SSH_KEY_NAME"
```

**Machine Pool Configuration:**
```yaml
"machine_pool.node_pool_config":
  filename: "{resource_name}_{pool_name}_config.yaml"
  templating:
    - path: "KubeadmControlPlane.spec.replicas"
      variable: "CONTROL_PLANE_REPLICAS"
    - path: "AWSMachineTemplate.spec.template.spec.instanceType"
      variable: "INSTANCE_TYPE"
```

#### Benefits

- ✅ **Parameterized Infrastructure** - Easy to customize deployments
- ✅ **Environment-Specific Values** - Different values per environment
- ✅ **Maintainable YAML** - Clean templates without hardcoded values
- ✅ **Terraform Integration** - Native override system

### Available Fields

Currently supported terraform attributes:
- **`cloud_config.values`** - Cluster cloud configuration YAML
- **`machine_pool.node_pool_config`** - Machine pool configuration YAML

Future support planned for:
- `cluster_profile.values` - Cluster profile layer configurations  
- `app_deployment.values` - Application deployment configurations

### Configuration Templates

**Simple Format (Backwards Compatible)**
```yaml
rules: ["yaml-format"]
output_dir: "yaml_configs"
backup: true
yaml_config:
  "cloud_config.values": "{resource_name}_cloud_config.yaml"
  "machine_pool.node_pool_config": "{resource_name}_{pool_name}_config.yaml"
```

**Advanced Templating Format**
```yaml
rules: ["yaml-format"]
output_dir: "yaml_configs"
backup: true
yaml_config:
  "cloud_config.values":
    filename: "{resource_name}_cloud_config.yaml"
    templating:
      - path: "Cluster.metadata.name"
        variable: "CLUSTER_NAME"
      - path: "AWSCluster.spec.region"
        variable: "AWS_REGION"
  "machine_pool.node_pool_config":
    filename: "{resource_name}_{pool_name}_config.yaml"
    templating:
      - path: "KubeadmControlPlane.spec.replicas"
        variable: "REPLICAS"
```

**Production Configuration**
```yaml
rules: ["yaml-format"]
output_dir: "configs" 
backup: true
yaml_config:
  "cloud_config.values":
    filename: "cluster-{resource_name}-cloud-config.yaml"
    templating:
      - path: "Cluster.spec.infrastructureRef.name"
        variable: "INFRA_REF_NAME"
      - path: "AWSCluster.spec.sshKeyName"
        variable: "SSH_KEY"
      - path: "AWSCluster.spec.region"
        variable: "REGION"
  "machine_pool.node_pool_config":
    filename: "cluster-{resource_name}-pool-{pool_name}.yaml"
    templating:
      - path: "*.spec.replicas"
        variable: "REPLICAS"
      - path: "AWSMachineTemplate.spec.template.spec.instanceType"
        variable: "INSTANCE_TYPE"
```

## Example Output

### Generated Files Structure
```
├── generated.tf                           # Updated Terraform file
├── generated.tf.backup                    # Original backup
└── yaml_configs/
    ├── cluster_cloud_config.yaml          # Clean YAML format
    ├── cluster_control-plane-pool_config.yaml
    └── cluster_worker-pool_config.yaml
```

### Cloud Config YAML Example
```yaml
# yaml_configs/cluster_cloud_config.yaml
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
    name: kun-simulate-tmo
spec:
    clusterNetwork:
        pods:
            cidrBlocks:
                - 192.168.0.0/16
    controlPlaneRef:
        apiVersion: controlplane.cluster.x-k8s.io/v1beta1
        kind: KubeadmControlPlane
        name: control-plane-pool
    infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
        kind: AWSCluster
        name: kun-simulate-tmo
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AWSCluster
metadata:
    name: kun-simulate-tmo
spec:
    network:
        vpc:
            availabilityZoneUsageLimit: 3
            id: vpc-0473fe94d2b9552d9
    region: us-west-2
    sshKeyName: spectro2023
```

### Updated Terraform File
```hcl
# generated.tf
resource "spectrocloud_cluster_custom_cloud" "example" {
  apply_setting        = "DownloadAndInstall"
  cloud                = "awstko271"
  cloud_account_id     = "67ee2b230739d09b0cea143b"
  context              = "tenant"
  name                 = "kun-simulate-tmo"
  
  cloud_config {
    overrides = {}
    values    = file("yaml_configs/cluster_cloud_config.yaml")
  }
  
  machine_pool {
    control_plane           = true
    control_plane_as_worker = false
    node_pool_config        = file("yaml_configs/cluster_control-plane-pool_config.yaml")
    overrides               = {}
  }
  
  machine_pool {
    control_plane           = false
    control_plane_as_worker = false
    node_pool_config        = file("yaml_configs/cluster_worker-pool_config.yaml")
    overrides               = {}
  }
}
```

## Advanced Usage

### Python Script Options

The Python script provides more advanced features:

```bash
# Basic usage
python format-yaml-config.py generated.tf

# Process multiple files
for file in *.tf; do
    python format-yaml-config.py "$file"
done

# With custom output directory (modify script if needed)
python format-yaml-config.py generated.tf
```

### Integration with CI/CD

```yaml
# .github/workflows/terraform.yml
name: Terraform Import and Format
on: [push]

jobs:
  import-and-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        
      - name: Initialize Terraform
        run: terraform init
        
      - name: Generate Config for Import
        run: terraform plan -generate-config-out=generated.tf
        
      - name: Format YAML Configs
        run: python scripts/format-yaml-config.py generated.tf
        
      - name: Verify Changes
        run: terraform plan
        
      - name: Commit Formatted Files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add generated.tf yaml_configs/
          git commit -m "Auto-format YAML configurations" || exit 0
          git push
```

## Benefits

### ✅ Improved Readability
- Multi-line YAML is properly formatted
- Syntax highlighting works in editors
- Easy to review and modify

### ✅ Better Version Control
- Clean diffs when YAML content changes
- Separate files for different configurations
- No more escaped string noise in reviews

### ✅ Enhanced Maintainability
- Edit YAML files directly with proper validation
- Reuse YAML configurations across resources
- Template YAML files with variables

### ✅ Development Experience
- IDE support for YAML editing
- Linting and validation tools work
- Copy-paste from external YAML sources

## Troubleshooting

### Common Issues

**1. Python Script Not Found**
```bash
# Make sure you're in the right directory
cd terraform-provider-spectrocloud
python spectrocloud/scripts/format-yaml-config.py generated.tf
```

**2. Permission Denied (Shell Script)**
```bash
chmod +x spectrocloud/scripts/format-yaml-config.sh
./spectrocloud/scripts/format-yaml-config.sh generated.tf
```

**3. No YAML Found**
- Ensure the Terraform file contains `cloud_config` blocks with `values` attributes
- Check that the YAML content is properly escaped

**4. Terraform Plan Fails After Processing**
- Review the generated YAML files for syntax errors
- Check file paths in `file()` references
- Verify relative paths are correct

### Recovery

If something goes wrong, both scripts create backups:

```bash
# Restore from backup
mv generated.tf.backup generated.tf

# Or regenerate from scratch
rm generated.tf
terraform plan -generate-config-out=generated.tf
```

## Contributing

To improve these scripts:

1. **Test with different YAML structures**
2. **Add support for more resource types**
3. **Improve error handling**
4. **Add validation for generated YAML**

## Examples Repository

See the `examples/spectrocloud_cluster_custom_cloud-import-demo/` directory for complete examples of:
- Import configurations
- Generated Terraform files
- Processed YAML configurations
- Working Terraform plans 