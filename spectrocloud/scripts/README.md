# Spectro Terraform Formatter (spectro-tf-format)

A CLI tool that converts escaped YAML content from Terraform files into clean, separate files with automatic variable extraction.

## Problem & Solution

**Before (Generated by Terraform):**
```hcl
cloud_config {
  values = "apiVersion: cluster.x-k8s.io/v1beta1\nkind: Cluster\nmetadata:\n    name: my-cluster\n..."
}
```

**After (Processed by spectro-tf-format):**
```hcl
cloud_config {
  overrides = {
    CLUSTER_NAME = "my-cluster"
    AWS_REGION   = "us-west-2"
  }
  values = file("cluster_configs_yaml/cluster_cloud_config.yaml")
}
```

## Quick Start

### 1. Install Dependencies
```bash
pip install -r spectrocloud/scripts/requirements.txt
chmod +x spectrocloud/scripts/spectro-tf-format
```

### 2. Basic Usage
```bash
# Generate Terraform configuration
terraform plan -generate-config-out=generated.tf

# Process with built-in defaults
spectro-tf-format generated.tf
```

### 3. Complete Workflow
```bash
# Import existing cluster
cat > import.tf << EOF
import {
  to = spectrocloud_cluster_custom_cloud.example  
  id = "cluster123:project:nutanix"
}
EOF

# Generate and process
terraform plan -generate-config-out=generated.tf
spectro-tf-format generated.tf

# Review results
ls cluster_configs_yaml/
terraform plan

# Clean up
rm import.tf
```

## What It Does

The tool automatically:
- âœ… Extracts YAML from `cloud_config.values` and `machine_pool.node_pool_config`
- âœ… Creates clean YAML files in `cluster_configs_yaml/` directory
- âœ… Replaces escaped strings with `file()` references
- âœ… Extracts values as Terraform variables (e.g., cluster names, regions, instance types)
- âœ… Adds `overrides` blocks for parameterization

## Configuration Options

```bash
# Custom output directory
spectro-tf-format --output-dir=configs generated.tf

# Skip backup creation
spectro-tf-format --no-backup generated.tf

# Skip terraform formatting
spectro-tf-format --no-format generated.tf
```

## Example Output Structure

```
â”œâ”€â”€ generated.tf                           # Updated with file() references
â”œâ”€â”€ cluster_configs_yaml/
â”‚   â”œâ”€â”€ cluster_cloud_config.yaml          # Clean YAML format
â”‚   â”œâ”€â”€ cluster_control-plane-pool_config.yaml
â”‚   â””â”€â”€ cluster_worker-pool_config.yaml
```

## Built-in Variable Extraction

The tool automatically extracts common values as variables:

**Cloud Config:**
- `CLUSTER_NAME` from cluster metadata
- `AWS_REGION` from AWSCluster spec

**Machine Pools:**
- `REPLICAS` from control plane/deployment specs
- `INSTANCE_TYPE` from machine templates
- `AMI_ID` from AWS machine templates
- `ROOT_VOLUME_SIZE` from volume configurations

## Benefits

- ðŸ“ **Clean YAML**: Proper formatting with syntax highlighting
- ðŸ”§ **Parameterized**: Variables extracted for easy customization
- ðŸ“ **Organized**: Separate files for different configurations
- ðŸ”„ **Version Control Friendly**: Clean diffs, no escaped strings

## Troubleshooting

**Script not found:**
```bash
python3 spectrocloud/scripts/spectro-tf-format generated.tf
```

**Restore from backup:**
```bash
mv generated.tf.backup generated.tf
```

**No YAML found:**
- Ensure file contains `cloud_config` or `machine_pool` blocks with YAML content
- Check that content isn't already processed (contains `file()` references)

For more advanced configuration options and detailed examples, see the script's built-in help:
```bash
spectro-tf-format --help
``` 